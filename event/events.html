<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Game Calendars</title>
   <style>
       .calendar-tabs { 
           display: flex; 
           gap: 10px;
           flex-wrap: wrap;
           padding: 10px;
       }
       .tab { 
           padding: 10px; 
           cursor: pointer;
           border-radius: 5px;
           color: white;
           text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
       }
       .tab.active { 
           box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
       }
       .calendar-grid { 
           display: grid;
           grid-template-columns: repeat(7, 1fr);
           gap: 10px;
           margin: 20px;
       }
       .controls {
           display: flex;
           justify-content: center;
           gap: 20px;
           margin: 20px;
       }
       .event { 
           padding: 10px;
           margin: 2px;
           border-radius: 5px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       }
       .day {
           border: 1px solid #ddd;
           padding: 5px;
           min-height: 100px;
       }
   </style>
</head>
<body>
   <div id="calendar-tabs" class="calendar-tabs"></div>
   <div id="calendar-view">
       <div class="controls">
           <button id="prev-month">Previous</button>
           <span id="current-month"></span>
           <button id="next-month">Next</button>
       </div>
       <div id="calendar-grid" class="calendar-grid"></div>
   </div>

   <script>
       const API_URL = 'https://isa-scavenger-761151e3e681.herokuapp.com';
       let activeCalendarId = null;

       async function getProxyToken(action) {
           const requestBody = { script_id: 'calendar_script', action };
           const response = await fetch(`${API_URL}/get_token`, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(requestBody)
           });
           if (!response.ok) {
               const errorText = await response.text();
               throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
           }
           const data = await response.json();
           if (data.token) return data.token;
           throw new Error('Failed to get token: ' + JSON.stringify(data));
       }

       async function makeRequest(action, additionalData = {}) {
           try {
               const token = await getProxyToken(action);
               const requestBody = { token, action, script_id: 'calendar_script', ...additionalData };
               const response = await fetch(`${API_URL}/proxy`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(requestBody)
               });
               if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
               }
               return response.json();
           } catch (error) {
               throw error;
           }
       }

       async function loadCalendars() {
           try {
               const response = await makeRequest('getCalendars');
               const calendars = response.calendars;
               
               const tabsContainer = document.getElementById('calendar-tabs');
               tabsContainer.innerHTML = '';
               
               calendars.forEach(cal => {
                   const tab = document.createElement('div');
                   tab.className = 'tab';
                   tab.textContent = cal.name;
                   tab.style.backgroundColor = cal.color;
                   tab.onclick = () => {
                       document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                       tab.classList.add('active');
                       loadCalendarEvents(cal.id);
                   };
                   tabsContainer.appendChild(tab);
               });

               if (calendars.length > 0) {
                   tabsContainer.firstChild.classList.add('active');
                   loadCalendarEvents(calendars[0].id);
               }
           } catch (error) {
               console.error('Error loading calendars:', error);
           }
       }

       async function loadCalendarEvents(calendarId) {
           try {
               activeCalendarId = calendarId;
               const response = await makeRequest('getEvents', { calendarId });
               renderCalendar(response.events);
           } catch (error) {
               console.error('Error loading events:', error);
           }
       }

       function createCalendarGrid() {
           const grid = document.getElementById('calendar-grid');
           grid.innerHTML = '';
           
           // Create header row for days of week
           const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
           days.forEach(day => {
               const dayHeader = document.createElement('div');
               dayHeader.textContent = day;
               dayHeader.style.fontWeight = 'bold';
               grid.appendChild(dayHeader);
           });

           // Create day cells
           for (let i = 0; i < 35; i++) {
               const dayCell = document.createElement('div');
               dayCell.className = 'day';
               grid.appendChild(dayCell);
           }
       }

       function renderCalendar(events) {
           createCalendarGrid();
           const grid = document.getElementById('calendar-grid');
           
           events.forEach(event => {
               const eventEl = document.createElement('div');
               eventEl.className = 'event';
               eventEl.textContent = `${event.title}\n${new Date(event.start).toLocaleTimeString()}`;
               eventEl.style.backgroundColor = event.color || '#4285f4';
               
               // Calculate which day cell to put the event in
               const eventDate = new Date(event.start);
               const dayIndex = eventDate.getDay() + Math.floor(eventDate.getDate() / 7) * 7;
               const dayCell = grid.children[dayIndex + 7]; // +7 to skip header row
               
               if (dayCell) {
                   dayCell.appendChild(eventEl);
               }
           });
       }

       document.getElementById('prev-month').onclick = () => {
           // Implement previous month logic
       };

       document.getElementById('next-month').onclick = () => {
           // Implement next month logic
       };

       // Initialize calendar
       loadCalendars();
   </script>
</body>
</html>