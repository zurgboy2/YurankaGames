<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendars</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    
        .calendar-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 20px;
            background-color: #1a1a1a;
        }
    
        .tab {
            padding: 15px;
            cursor: pointer;
            border-radius: 10px;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }
    
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
        }
    
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px;
            background-color: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
        }
    
        .day {
            border: 1px solid #333;
            padding: 5px;
            min-height: 100px;
            background-color: #2a2a2a;
            border-radius: 5px;
            color: white;
        }

        .event {
            padding: 10px;
            margin: 2px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            color: white;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Header section from second document -->
        <header>
            <div class="container">
                <div class="header-content">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo-container">
                        <div class="logo">
                            <img src="https://ik.imagekit.io/mcgszbooe/Logo?updatedAt=1717316244029" alt="Yuranka Games Logo">
                        </div>
                        <span class="logo-text">YURANKA GAMES</span>
                    </div>
                    <nav class="main-nav" id="mainNav">
                        <ul>
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="https://store.yuranka.com">Store</a></li>            
                            <li><a href="../boardgame.html">Board Games</a></li>
                            <li><a href="../videogame.html">Video Games</a></li>
                            <li><a href="../registration.html">Reservations</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropbtn">Events</a>
                                <div class="dropdown-content">
                                    <a href="event-registration.html">Events Registration</a>
                                    <a href="mini-con.html">Mini - Cons</a>
                                    <a href="events.html">Events</a>
                                </div>
                            </li>
                            <li><a href="../about.html">About</a></li>
                            <li><a href="https://store.yuranka.com/pages/contact">Contact</a></li>
                        </ul>
                    </nav>
                    <div id="userProfileContainer"></div>
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <main class="main-content">
                <div id="calendar-tabs" class="calendar-tabs"></div>
                <div id="calendar-view">
                    <div class="controls">
                        <button id="prev-month">Previous</button>
                        <span id="current-month"></span>
                        <button id="next-month">Next</button>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </main>
        </div>

        <div class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="https://store.yuranka.com">Store</a></li>  
                    <li><a href="../boardgame.html">Board Games</a></li>
                    <li><a href="../videogame.html">Video Games</a></li>
                    <li><a href="../registration.html">Reservations</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropbtn">Events</a>
                        <div class="dropdown-content">
                            <a href="event-registration.html">Events Registration</a>
                            <a href="mini-con.html">Mini - Cons</a>
                            <a href="events.html">Events</a>
                        </div>
                    </li>
                    <li><a href="../about.html">About</a></li>
                    <li><a href="https://store.yuranka.com/pages/contact">Contact</a></li>
                </ul>
            </nav>
            <div id="sidebarUserProfileContainer"></div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="loading-message">Please wait...</div>
    </div>

        <footer class="site-footer">
            <a href="https://www.yuranka.com/bug-report.html" target="_blank" class="bug-report-btn">
                <i class="fas fa-bug"></i> Report a Bug
            </a>
        </footer>
    </div>

   <script>
       const API_URL = 'https://isa-scavenger-761151e3e681.herokuapp.com';
       let activeCalendarId = null;

       async function getProxyToken(action) {
           const requestBody = { script_id: 'calendar_script', action };
           const response = await fetch(`${API_URL}/get_token`, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(requestBody)
           });
           if (!response.ok) {
               const errorText = await response.text();
               throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
           }
           const data = await response.json();
           if (data.token) return data.token;
           throw new Error('Failed to get token: ' + JSON.stringify(data));
       }

       async function makeRequest(action, additionalData = {}) {
           try {
               const token = await getProxyToken(action);
               const requestBody = { token, action, script_id: 'calendar_script', ...additionalData };
               const response = await fetch(`${API_URL}/proxy`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(requestBody)
               });
               if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
               }
               return response.json();
           } catch (error) {
               throw error;
           }
       }

       async function loadCalendars() {
           try {
               const response = await makeRequest('getCalendars');
               const calendars = response.calendars;
               
               const tabsContainer = document.getElementById('calendar-tabs');
               tabsContainer.innerHTML = '';
               
               calendars.forEach(cal => {
                   const tab = document.createElement('div');
                   tab.className = 'tab';
                   tab.textContent = cal.name;
                   tab.style.backgroundColor = cal.color;
                   tab.onclick = () => {
                       document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                       tab.classList.add('active');
                       loadCalendarEvents(cal.id);
                   };
                   tabsContainer.appendChild(tab);
               });

               if (calendars.length > 0) {
                   tabsContainer.firstChild.classList.add('active');
                   loadCalendarEvents(calendars[0].id);
               }
           } catch (error) {
               console.error('Error loading calendars:', error);
           }
       }

       async function loadCalendarEvents(calendarId) {
           try {
               activeCalendarId = calendarId;
               const response = await makeRequest('getEvents', { calendarId });
               renderCalendar(response.events);
           } catch (error) {
               console.error('Error loading events:', error);
           }
       }

       function createCalendarGrid() {
           const grid = document.getElementById('calendar-grid');
           grid.innerHTML = '';
           
           // Create header row for days of week
           const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
           days.forEach(day => {
               const dayHeader = document.createElement('div');
               dayHeader.textContent = day;
               dayHeader.style.fontWeight = 'bold';
               grid.appendChild(dayHeader);
           });

           // Create day cells
           for (let i = 0; i < 35; i++) {
               const dayCell = document.createElement('div');
               dayCell.className = 'day';
               grid.appendChild(dayCell);
           }
       }

       function renderCalendar(events) {
           createCalendarGrid();
           const grid = document.getElementById('calendar-grid');
           
           events.forEach(event => {
               const eventEl = document.createElement('div');
               eventEl.className = 'event';
               eventEl.textContent = `${event.title}\n${new Date(event.start).toLocaleTimeString()}`;
               eventEl.style.backgroundColor = event.color || '#4285f4';
               
               // Calculate which day cell to put the event in
               const eventDate = new Date(event.start);
               const dayIndex = eventDate.getDay() + Math.floor(eventDate.getDate() / 7) * 7;
               const dayCell = grid.children[dayIndex + 7]; // +7 to skip header row
               
               if (dayCell) {
                   dayCell.appendChild(eventEl);
               }
           });
       }

       document.getElementById('prev-month').onclick = () => {
           // Implement previous month logic
       };

       document.getElementById('next-month').onclick = () => {
           // Implement next month logic
       };

       // Initialize calendar
       loadCalendars();
   </script>
</body>
</html>